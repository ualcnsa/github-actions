= Primer ejemplo: Documentaci贸n en Antora

== Introducci贸n a Antora

Antora permite gestionar la documentaci贸n de un proyecto como si fuera c贸digo. Esto significa que el proceso de documentaci贸n se beneficia de las mismas pr谩cticas utilizadas para producir software con 茅xito.

Algunas de estas pr谩cticas son:

* Almacenar el contenido en un sistema de control de versiones.
* Separar el contenido, la configuraci贸n y la presentaci贸n.
* Aprovechar la automatizaci贸n para la compilaci贸n, validaci贸n, verificaci贸n y publicaci贸n.
* Reutilizaci贸n de materiales compartidos (DRY).

Antora ayuda a incorporar estas pr谩cticas en el flujo de trabajo de documentaci贸n. Como resultado, la documentaci贸n es mucho m谩s f谩cil de gestionar, mantener y mejorar.

== Creaci贸n del repositorio

Para empezar a trabajar solo necesitas un repositorio alojado en GitHub de tipo *p煤blico*.

[NOTE]
====
Las *GitHub Actions* funcionan tanto con repositorios *p煤blicos* como *privados*. Sin embargo, otras funciones como las *GitHub Pages* solo funcionan con los repositorios *p煤blicos*.
====

En este repositorio subiremos el contenido de https://github.com/ualcnsa/cicd/archive/232cf038086dc798e51d5201bba9945277562851.zip[un proyecto de documentaci贸n en Antora].

1. Descomprimimos el archivo en un directorio
2. Entramos al directorio y hacemos `git init`
3. Creamos la rama principal `git checkout -b main`
4. Hacemos commit de todos los archivos con `git add -A && git commit`
5. A帽adimos el remote de nuestro repositorio `git remote add origin <direcci贸n-repositorio>`
6. Subimos la rama local `git push origin main``

Nuestro repositorio tiene que tener la siguiente estructura:

image::github-antora-files.png[role="thumb", align="center"]

== Creando el workflow para Antora

A continuaci贸n, vamos a a帽adir un workflow que construya nuestro proyecto en Antora.

Al tratarse de un proyecto basado en NodeJS, utilizaremos una imagen Docker con 茅ste instalado y seguiremos un proceso de construcci贸n com煤n a 茅ste tipo de proyectos.

[NOTE]
=====
Para m谩s informaci贸n sobre la construcci贸n de proyectos Antora https://docs.antora.org/antora/latest/install-and-run-quickstart/
=====

1. Crea un directorio `.github/workflows`.
2. En este directorio, crea un fichero llamado `build.yml`.
3. Copia el siguiente contenido YAML en el fichero anterior.
+
.build.yml
[source, yaml]
----
name: CI

on: <1>
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: <2>

jobs:
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    container: node:16-alpine <3>
    steps:
      - uses: actions/checkout@v2

      - name: Install dependencies <4>
        run: npm install

      - name: Build Antora project <5>
        run: |
          cp -R node_modules/@antora/lunr-extension/supplemental_ui/* supplemental-ui/ <6>
          npx antora local-antora-playbook.yml --fetch <7>
----
<1> Se ejecuta al hacer *push* en la rama *main* o un *pull request* con destino *main*.
<2> Podemos lanzar el workflow cuando queramos.
<3> Utilizamos una imagen Docker con NodeJS 16 instalado.
<4> Instalamos las dependencias del proyecto NodeJS.
<5> Construimos el proyecto Antora.
<6> Paso extra necesario al utilizar la extensi贸n https://gitlab.com/antora/antora-lunr-extension#user-content-enable-the-search-interface[@antora/lunr-extension]
<7> Comando para construir la documentaci贸n Antora a partir del playbook.

4. Hacemos `commit` de los cambios y hacemos `push` a la rama remota
+
```
git add -A && git commit
git push origin main
```

Podemos comprobar que todo se ha realizado correctamente, viendo el resultado de la acci贸n.

image::github-antora-build.png[role="thumb", align="center"]

== Descarga de los artefactos (artifacts)

Hemos conseguido configurar un workflow que permite compilar la documentaci贸n en Antora cada vez que se hace un pull request, un push a main o de forma manual.

Sin embargo, no tenemos acceso a la p谩gina web que se construye.

Si queremos asociar la documentaci贸n a cada ejecuci贸n tenemos que hacer uso de un action que suba artefactos (artifacts).

1. Vamos al https://github.com/marketplace?type=actions[GitHub Actions Marketplace]

2. Buscamos la palabra `artifact`.
+
image::github-marketplace-artifact.png[role="thumb", align="center"]

3. Seleccionamos `Upload a Build Artifact` que es un action creado por GitHub.
+
image::github-marketplace-artifact-desc.png[role="thumb", align="center"]

4. Buscamos como utilizar la action en su documentaci贸n.
+
image::github-marketplace-artifact-doc.png[role="thumb", align="center"]

5. Modificamos nuestro flujo `build.yml`` con un paso extra.
+
.build.yml
[source, yaml]
----
...
      # Uploads the generated site
       - uses: actions/upload-artifact@v3
         with:
           name: docs <1>
           path: docs/ <2>
----
<1> Nombre del fichero zip que descargaremos.
<2> Carpeta con la documentaci贸n. Por defecto Antora usa el directorio `docs`

Tras hacer un push o una pull request, se ejecutar谩 el workflow y podemos descargar la documentaci贸n en el zip del final de la p谩gina.

image::github-antora-artifact.png[role="thumb", align="center"]

== Despliegue en GitHub Pages

Es un servicio de GitHub que ermite publicar paginas en HTML estatico o en Jekyll. 

Adem谩s proporciona un dominio y url publicas:

* https://organizacion.github.io
* https://organizacion.github.io/repositorio

Podemos desplegar un sitio web mediante un directorio en el repositorio o con una rama especial (gh-pages). 

Este servicio es usado normalmente para despliegue de frontends o portales de documentacion de repositorios, como el caso que nos ocupa.

1. Vamos a utilizar el action https://github.com/marketplace/actions/deploy-to-github-pages[`Deploy to GitHub Pages`].
+
image::github-marketplace-pages.png[role="thumb", align="center"]

2. Leemos la documentaci贸n.
+
[IMPORTANT]
====
Si utilizamos un contenedor tenemos que tener instalado `git` y `rsync` para usar esta action.

[source, yaml]
----
- name: Install rsync and git
  run: |
    apt-get update && apt-get install -y rsync git
    # apk update && apk add rsync git
- name: Deploy 
  uses: JamesIves/github-pages-deploy-action@v4.2.5
----
==== 

3. Modificamos los pasos de nuestro flujo `build.yml` como primer y 煤ltimo paso
+
.build.yml
[source, yaml]
----
    steps:
       - name: Install git and rsync 
         run: |
           apk update && apk add git rsync

...

      - name: Deploy 
         uses: JamesIves/github-pages-deploy-action@v4.2.5
         with:
           branch: gh-pages <1>
           folder: docs <2>
           clean: true <3>

----
<1> La rama donde vamos a desplegar.
<2> La carpeta que queremos desplegar.
<3> Si queremos limpiar la rama para evitar que ficheros no existentes se queden en la rama.

4. Hacemos commit y subimos los cambios.
5. Una vez se ha ejecutado la acci贸n, configuramos el soporte para *GitHub Pages*. Entramos en `Settings > Pages` y seleccionamos la rama `gh-pages` como origen.
+
image::github-pages.png[role="thumb", align="center"]

6. En esta p谩gina podemos consultar la `url` de la documentaci贸n desplegada.
